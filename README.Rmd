---
output: 
  github_document:
    html_preview: FALSE
    toc: FALSE
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
library(sasf)
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)
library(ragg)
library(janitor)

knitr::opts_chunk$set(
  eval = TRUE,
  echo = TRUE,
  messages = FALSE,
  warnings = FALSE,
  errors = FALSE,
  comment = "#>",
  fig.align = "center",
  fig.path = "man/figures/readme/",
  dev = "ragg_png",
  dpi = 180,
  out.width = "100%",
  cache = TRUE,
  cache.path = "man/cache/readme/"
)
```

# `sasf`

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/sasf)](https://CRAN.R-project.org/package=sasf)
<!-- badges: end -->

The goal of `sasf` is to simplify the process of loading and visualising spatial data for South Africa in `R`.
Shapefiles encompass various administrative levels, such as provinces, districts, municipalities, mainplaces, and subplaces, using Census 2011 demarcations.

The main dataset of interest `subplaces` data frame is embedded in the package. 
`_id` columns represent unique numeric identifiers, while `_name` columns provide descriptive names.
`_mdb` columns present string identifiers corresponding to the demarcations of the Municipal Demarcation Board of South Africa for provinces, districts, and municipalities.

## Installation

<!-- This package requires a working installation of [`sf`](https://github.com/r-spatial/sf#installing). -->

You can install the development version of `sasf` from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("WihanZA/sasf")
```

## Basics

```r
# load the package
library(sasf)

# recommended packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)
library(ragg)
```

Somewhat large datasets are lazily loaded to reduce the demand on your system's memory when they're not in use.
See memory usage before and after loading the `subplaces` dataset.

```{r, lazy}
lobstr::mem_used()
invisible(subplaces)
lobstr::mem_used()
```

`subplaces` is structured hierarchically:

```{r hierarchy}
subplaces %>%
  st_drop_geometry() %>%
  select(ends_with("_id")) %>%
  pivot_longer(everything()) %>%
  group_by(name) %>%
  summarise(n = n_distinct(value)) %>%
  arrange(desc(n))
```

## Plotting

I recommend the `ggplot2` package for visualising the spatial data:

```{r basic-plot}
subplaces %>%
  ggplot() +
  geom_sf()
```

Maintain consistently formatted figures by setting default themes:

```{r plot-defaults, cache = FALSE}
# set default ggplot theme
theme_set(
  theme_void() +
    theme(
      legend.position = "bottom",
      legend.box = "vertical"
    )
)

# set GeomSf defaults
update_geom_defaults(
  "sf",
  list(alpha = 0.5)
)

# create new plot
subplaces %>%
  filter(province_name == "Western Cape") %>%
  group_by(district_name) %>%
  summarise() %>%
  ggplot(aes(fill = district_name)) +
  geom_sf(color = "grey50") +
  labs(
    fill = "District Muncipality",
    title = "Western Cape Districts"
  )
```

## Helper Functions

Arbitrarily setting generated figures' dimensions with code chunk options `fig.width` and `fig.height`, or the `width` and `height` arguments to `ggsave`, may amount to aspect ratios which don't correspond to that of the `sf` object.
This leads to redundant whitespace in the image created by `knitr` or `ggsave`.

To prevent this, the `sasf` package offers the `get_asp` helper function.
It takes an `sf` object (and optionally a figure's target width), and returns its inherent aspect ratio (and target height), accounting for any latitude distortion where present.

The aforementioned unintended whitespace---and the fix provided by `get_asp`---is best illustrated with images generated using `ggsave` although the outcome is very much the same as with inappropriate code chunk options.

```{r gauteng-example, fig.show = "hold", out.width="50%"}
# filter spatial data
gauteng_sf <- subplaces %>%
  filter(province_name == "Gauteng")

# create plot
gauteng_plot <- gauteng_sf %>%
  ggplot() +
  geom_sf(
    aes(fill = subplace_id),
    show.legend = FALSE
  ) +
  theme(
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "grey50")
  )

# save images to the same path
fig_path <- "man/figures/readme"

# with arbitrary dimensions 6x5
ggsave(
  filename = "gauteng-whitespace.png",
  plot = gauteng_plot,
  device = ragg::agg_png,
  path = fig_path,
  width = 6,
  height = 5,
  dpi = 180
)

# get ideal asepct ratio for the sf object
# targeting the same width as before
gauteng_asp <- get_asp(
  sf_obj = gauteng_sf,
  target_width = 6
)

gauteng_asp

# with recommended dimensions
ggsave(
  filename = "gauteng-corrected.png",
  plot = gauteng_plot,
  device = ragg::agg_png,
  path = fig_path,
  width = gauteng_asp$target_width,
  height = gauteng_asp$target_height,
  dpi = 180
)

# using out.width = 50%
knitr::include_graphics(file.path(fig_path, "gauteng-whitespace.png"))
knitr::include_graphics(file.path(fig_path, "gauteng-corrected.png"))
```

## Complete Example

The aim of this example is to illustrate how other sources of spatial data can be used alongside `sasf` to enhance and complement visualisations and analyses.
Ultimately, we want to plot the locations of datacentres across South Africa.

### Data: Open Access Datacentres

Download, process and plot spatial data on open access datacentres in Africa which has been collected from publicly available sources.
Big thanks to [Steve Song](https://github.com/stevesong/Africa-Datacentres)!

```{r datacentres-download}
# set path to resources for README
resources <- "man/resources/readme"

# download raw geojson data
if (!file.exists(file.path(resources, "datacentres.geojson"))) {
  download.file(
    url = "https://raw.githubusercontent.com/stevesong/Africa-Datacentres/refs/heads/main/Africa_datacentres_05Jan2025.geojson",
    destfile = file.path(resources, "datacentres.geojson"),
    method = "curl"
  )
}

# read geojson file
datacentres <- geojsonsf::geojson_sf(file.path(resources, "datacentres.geojson"))

# clean column names and filter data
datacentres <- datacentres %>%
  clean_names() %>%
  filter(grepl("south africa", country, ignore.case = TRUE))

# convert char to num where appropriate
char_to_num <- function(col) {
  num <- suppressWarnings(as.numeric(col))
  if (all(is.na(num))) {
    return(col)
  } else {
    return(num)
  }
}

datacentres <- datacentres %>%
  mutate(across(
    where(is.character) & !matches("post_code"),
    ~ char_to_num(.x)
  ))

# clean char columns
datacentres <- datacentres %>%
  mutate(across(
    where(is.character),
    ~ case_when(
      . == "" ~ NA,
      TRUE ~ stringr::str_squish(.)
    )
  ))

# take a look at the structure
glimpse(datacentres)
```

### Aggregate `subplaces` to Create Borders

For many use cases, spatial data by subplace is too granular and computationally cumbersome.
The dimensions of the `subplaces` dataset can be reduced by aggregating the geometries of individual subplaces toward less granular administrative levels/geographic units.
In this example, we merely want to plot provincial borders.

There are various ways to accomplish this feat and below we'll benchmark a couple of similar approaches:
  - [`rmapshaper`](https://andyteucher.ca/rmapshaper/) relying on the [`mapshaper`](https://github.com/mbloch/mapshaper/) tool written in JavaScript. We benchmark the package's `ms_dissolve` with and without the use of a locally installed `mapshaper` library.
  - [`sf`](https://r-spatial.github.io/sf/index.html) package's well-known [`st_union`](https://r-spatial.github.io/sf/reference/geos_combine.html) to combine several feature geometries into one with- or without resolving internal boundaries.

Each approach has their own peculiar costs and benenfits.
The execution time will also differ dramatically depending on each function's given set of arguments, as well as the given spatial data of interest.
It is up to the user to determine the best approach for their use case.

``` r
# dissolve internal boundaries
tictoc::tic("dissolve")
provinces <- subplaces %>%
  rmapshaper::ms_dissolve(field = "province_name")
tictoc::toc()
```

    #> dissolve: 6.87 sec elapsed

``` r
# confirm local installation
# rmapshaper::check_sys_mapshaper()

# dissolve internal boundaries + local library
tictoc::tic("dissolve_sys")
provinces <- subplaces %>%
  rmapshaper::ms_dissolve(
    field = "province_name",
    sys = TRUE,
    sys_mem = 6,
    quiet = TRUE
  )
tictoc::toc()
```

    #> dissolve_sys: 4.39 sec elapsed

``` r
# geometric union of set of features into a single one
tictoc::tic("st_union")
provinces <- subplaces %>%
  group_by(province_name) %>%
  summarise(geometry = st_union(geometry, by_feature = FALSE))
tictoc::toc()
```

    #> st_union: 47.88 sec elapsed

```{r provinces, echo = FALSE, include = FALSE}
provinces <- subplaces %>%
  rmapshaper::ms_dissolve(
    field = "province_name",
    sys = TRUE,
    sys_mem = 6,
    quiet = TRUE
  )
```


```{r datacentres-plot, eval = FALSE, include = FALSE}
# plot datacentres
datacentres %>%
  ggplot() +
  geom_sf(
    data = provinces,
    color = "grey50",
    fill = NA,
    linewidth = 1
  ) +
  geom_sf(
    aes(color = company),
    data = datacentres,
    size = 20,
    alpha = 0.2
  ) +
  labs(
    title = "Open Access Datacentres in South Africa",
    color = "Company"
  )
```


# Acknowledgements

- Demarcations used by the 2011 Census are detailed in the *[metadata](https://www.statssa.gov.za/census/census_2011/census_products/Census_2011_Metadata.pdf)* published by Statistics South Africa (2012).

- The wiki by [konektaz](https://github.com/konektaz) offers a useful summary of the hierarchical structure of spatial layers: *[South Africa Census 2011 spatial metadata](https://github.com/konektaz/shape-files/wiki/South-Africa---Census-2011-spatial-metadata)*

- The original shapefiles were sourced from the [OpenUp Data Portal](https://data.openup.org.za/) at this link: *[Census 2011 Boundaries Subplace Layer](https://data.openup.org.za/dataset/census-2011-boundaries-subplace-layer-qapr-gczi/)*

# Session Information

```{r info, cache = FALSE}
sessionInfo()
```