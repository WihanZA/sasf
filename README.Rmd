---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
rm(list = ls())
gc()

library(tidyverse)
library(sf)
library(ragg)
devtools::load_all()

# remove.packages("rsa.shapefiles")
# install.packages("~/Documents/GitHub/Packages/rsa.shapefiles", type = "source")

knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  eval = TRUE,
  cache = TRUE,
  cache.path = "man/cache/README-",
  fig.path = "man/figures/README-",
  out.width = "100%",
  dpi = 300,
  dev = "ragg_png"
)
```

# `rsa.shapefiles`

<!-- badges: start -->
<!-- badges: end -->

The `rsa.shapefiles` package provides easy access to geographic shapefiles with demarcations derived from South Africa's Census 2011. These shapefiles include various administrative levels such as provinces, districts, municipalities, main places, and subplaces. The package simplifies the process of loading and visualising spatial data for South Africa.

The geographic codes in the `subplaces` data frame follow a hierarchical structure consisting of multiple administrative levels. The **municipality code** (`municipality_id`) is a three-digit identifier, where the first digit represents the province and the next two are unique to the municipality (e.g., `167` for Stellenbosch). The **main place code** (`mainplace_id`) is a six-digit identifier, the first three digits matching the municipality code and the last three uniquely identifying the main place (e.g., `167007` for Franschhoek). Similarly, the **subplace code** (`subplace_id`) is a nine-digit identifier, where the first six correspond to the main place and the last three uniquely identify the subplace (e.g., `167007001` for Wemmershoek).

## Installation

You can install the development version from this Github repository via the [`remotes`](https://github.com/r-lib/remotes#readme) package in R.

```r
# install.packages("remotes")
remotes::install_github("WihanZA/rsa.shapefiles")
```

## Examples

### Loading data

```{r loading}
library(rsa.shapefiles)
subplaces <- rsa.shapefiles::subplaces
```

### Filter data

```{r filtering}
subplaces %>%
  filter(grepl("Stellenbosch", municipality_name)) %>%
  distinct(
    municipality_id, municipality_name,
    mainplace_id, mainplace_name,
    subplace_id, subplace_name
  ) %>%
  head()
```

### Plotting data

```{r plotting}
library(ggplot2)

ggplot() +
  theme_void() +
  geom_sf(data = subplaces, color = "grey50")
```

### Aggregating data with `st_union`

```{r aggregating}
library(sf)

provinces <- subplaces %>%
  group_by(province_id) %>%
  summarise(
    geometry = st_union(geometry),
    .groups = "drop"
  )

ggplot() +
  theme_void() +
  # use province borders
  geom_sf(
    data = provinces,
    color = "white",
    fill = NA,
    linewidth = 0.25
  ) +
  # use subplace fill
  geom_sf(
    data = subplaces,
    aes(fill = stringr::str_sub(subplace_id, 6, 9)),
    color = NA,
    show.legend = FALSE
  ) +
  scale_fill_viridis_d(option = "magma", begin = 0.15)
```


# Acknowledgements

- The definitions and demarcations used in Census 2011 are detailed in the **[Census 2011 Metadata](https://www.statssa.gov.za/census/census_2011/census_products/Census_2011_Metadata.pdf)**, published by Statistics South Africa (2012). The document provides comprehensive information on the geographical boundaries, coding structures, and methodologies used for the census.

- This wiki by [konektaz](https://github.com/konektaz) provdides a useful summary of the hierarchical structure of spatial layers: [South Africa Census 2011 spatial metadata](https://github.com/konektaz/shape-files/wiki/South-Africa---Census-2011-spatial-metadata)

- The original shapefiles were sourced from the [OpenUp Data Portal](https://data.openup.org.za/) at this link: [Census 2011 Boundaries Subplace Layer](https://data.openup.org.za/dataset/census-2011-boundaries-subplace-layer-qapr-gczi/)
